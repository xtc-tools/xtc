# RUN: python %s 2>&1 | filecheck %s
"""
Test strategy PPRPRP (Ansor like tiling for all axes) on conv2d
"""
import utils
from xtc.search.strategies import Strategy_PPRPRP as Strategy

graph = utils.get_graph_conv2d()
backend = utils.get_backend(graph)
strategy = Strategy(graph, max_unroll=8, threads=4)

utils.print_all_opt_schedules(backend, strategy)
utils.print_exhaustive_samples(backend, strategy, 100)

# CHECK:       schedule O0: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_fill', node_ident='__xtc_id_%2_fill_', dims=['b', 'h', 'w', 'f'], loop_stamps=[], splits={}, tiles={'b': {'b': 1}, 'h': {'h': 1}, 'w': {'w': 1}, 'f': {'f': 1}}, permutation={'.': ['b', 'h', 'w', 'f']}, vectorization=[], parallelization=[], unrolling={}), MlirNodeSchedule(node_name='%2_reduce', node_ident='__xtc_id_%2_reduce_', dims=['b', 'h', 'w', 'f', 'r', 's', 'c'], loop_stamps=[], splits={}, tiles={'b': {'b': 1, 'b1': 1, 'b2': 1, 'b3': 1}, 'h': {'h': 1, 'h1': 1, 'h2': 1, 'h3': 1}, 'w': {'w': 1, 'w1': 1, 'w2': 1, 'w3': 1}, 'f': {'f': 1, 'f1': 1, 'f2': 1, 'f3': 1}, 'r': {'r': 1, 'r1': 1}, 's': {'s': 1, 's1': 1}, 'c': {'c': 1, 'c1': 1}}, permutation={'%2_reduce': ['b', 'h', 'w', 'f', 'b1', 'h1', 'w1', 'f1', 'r', 's', 'c', 'b2', 'h2', 'w2', 'f2', 'r1', 's1', 'c1', 'b3', 'h3', 'w3', 'f3']}, vectorization=['f3'], parallelization=['b'], unrolling={'f3': 1, 'w3': 1, 'h3': 1, 'b3': 1, 'c1': 1, 's1': 1, 'r1': 1})]
# CHECK-NEXT:  schedule O1: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_fill', node_ident='__xtc_id_%2_fill_', dims=['b', 'h', 'w', 'f'], loop_stamps=[], splits={}, tiles={'b': {'b': 1}, 'h': {'h': 1}, 'w': {'w': 1}, 'f': {'f': 1}}, permutation={'.': ['b', 'h', 'w', 'f']}, vectorization=[], parallelization=[], unrolling={}), MlirNodeSchedule(node_name='%2_reduce', node_ident='__xtc_id_%2_reduce_', dims=['b', 'h', 'w', 'f', 'r', 's', 'c'], loop_stamps=[], splits={}, tiles={'b': {'b': 1, 'b1': 1, 'b2': 1, 'b3': 1}, 'h': {'h': 1, 'h1': 1, 'h2': 1, 'h3': 1}, 'w': {'w': 1, 'w1': 1, 'w2': 1, 'w3': 1}, 'f': {'f': 1, 'f1': 1, 'f2': 1, 'f3': 1}, 'r': {'r': 1, 'r1': 1}, 's': {'s': 1, 's1': 1}, 'c': {'c': 1, 'c1': 1}}, permutation={'%2_reduce': ['b', 'h', 'w', 'f', 'b1', 'h1', 'w1', 'f1', 'r', 's', 'c', 'b2', 'h2', 'w2', 'f2', 'r1', 's1', 'c1', 'b3', 'h3', 'w3', 'f3']}, vectorization=['f3'], parallelization=['b'], unrolling={'f3': 1, 'w3': 1, 'h3': 1, 'b3': 1, 'c1': 1, 's1': 1, 'r1': 1})]
# CHECK-NEXT:  schedule O2: [1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 16, 1, 1, 1]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_fill', node_ident='__xtc_id_%2_fill_', dims=['b', 'h', 'w', 'f'], loop_stamps=[], splits={}, tiles={'b': {'b': 1}, 'h': {'h': 1}, 'w': {'w': 1}, 'f': {'f': 1}}, permutation={'.': ['b', 'h', 'w', 'f']}, vectorization=[], parallelization=[], unrolling={}), MlirNodeSchedule(node_name='%2_reduce', node_ident='__xtc_id_%2_reduce_', dims=['b', 'h', 'w', 'f', 'r', 's', 'c'], loop_stamps=[], splits={}, tiles={'b': {'b': 1, 'b1': 1, 'b2': 1, 'b3': 1}, 'h': {'h': 1, 'h1': 1, 'h2': 1, 'h3': 1}, 'w': {'w': 2, 'w1': 2, 'w2': 2, 'w3': 1}, 'f': {'f': 16, 'f1': 16, 'f2': 16, 'f3': 1}, 'r': {'r': 1, 'r1': 1}, 's': {'s': 1, 's1': 1}, 'c': {'c': 1, 'c1': 1}}, permutation={'%2_reduce': ['b', 'h', 'w', 'f', 'b1', 'h1', 'w1', 'f1', 'r', 's', 'c', 'b2', 'h2', 'w2', 'f2', 'r1', 's1', 'c1', 'b3', 'h3', 'w3', 'f3']}, vectorization=['f3'], parallelization=['b'], unrolling={'f3': 16, 'w3': 2, 'h3': 1, 'b3': 1, 'c1': 1, 's1': 1, 'r1': 1})]
# CHECK-NEXT:  schedule O3: [1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 16, 1, 1, 3]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_fill', node_ident='__xtc_id_%2_fill_', dims=['b', 'h', 'w', 'f'], loop_stamps=[], splits={}, tiles={'b': {'b': 1}, 'h': {'h': 1}, 'w': {'w': 1}, 'f': {'f': 1}}, permutation={'.': ['b', 'h', 'w', 'f']}, vectorization=[], parallelization=[], unrolling={}), MlirNodeSchedule(node_name='%2_reduce', node_ident='__xtc_id_%2_reduce_', dims=['b', 'h', 'w', 'f', 'r', 's', 'c'], loop_stamps=[], splits={}, tiles={'b': {'b': 1, 'b1': 1, 'b2': 1, 'b3': 1}, 'h': {'h': 1, 'h1': 1, 'h2': 1, 'h3': 1}, 'w': {'w': 2, 'w1': 2, 'w2': 2, 'w3': 1}, 'f': {'f': 16, 'f1': 16, 'f2': 16, 'f3': 1}, 'r': {'r': 1, 'r1': 1}, 's': {'s': 1, 's1': 1}, 'c': {'c': 3, 'c1': 1}}, permutation={'%2_reduce': ['b', 'h', 'w', 'f', 'b1', 'h1', 'w1', 'f1', 'r', 's', 'c', 'b2', 'h2', 'w2', 'f2', 'r1', 's1', 'c1', 'b3', 'h3', 'w3', 'f3']}, vectorization=['f3'], parallelization=['b'], unrolling={'f3': 16, 'w3': 2, 'h3': 1, 'b3': 1, 'c1': 3, 's1': 1, 'r1': 1})]
# CHECK-NEXT:  sample 0: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
# CHECK-NEXT:  sample 1: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3]
# CHECK-NEXT:  sample 2: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 1]
# CHECK-NEXT:  sample 3: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 1, 1]
# CHECK-NEXT:  sample 4: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1]
# CHECK-NEXT:  sample 5: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 3]
# CHECK-NEXT:  sample 6: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 7, 1]
# CHECK-NEXT:  sample 7: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 7, 1, 1]
# CHECK-NEXT:  sample 8: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 1]
# CHECK-NEXT:  sample 9: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 3]
# CHECK-NEXT:  sample 10: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 7, 1]
# CHECK-NEXT:  sample 11: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 7, 1, 1]
# CHECK-NEXT:  sample 12: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1]
# CHECK-NEXT:  sample 13: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 3]
# CHECK-NEXT:  sample 14: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 7, 1]
# CHECK-NEXT:  sample 15: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 7, 1, 1]
# CHECK-NEXT:  sample 16: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 1]
# CHECK-NEXT:  sample 17: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 3]
# CHECK-NEXT:  sample 18: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 7, 1]
# CHECK-NEXT:  sample 19: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 7, 1, 1]
# CHECK-NEXT:  sample 20: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 32, 1, 1, 1]
# CHECK-NEXT:  sample 21: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 32, 1, 1, 3]
# CHECK-NEXT:  sample 22: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1]
# CHECK-NEXT:  sample 23: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 3]
# CHECK-NEXT:  sample 24: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 7, 1]
# CHECK-NEXT:  sample 25: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 7, 1, 1]
# CHECK-NEXT:  sample 26: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1]
# CHECK-NEXT:  sample 27: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 3]
# CHECK-NEXT:  sample 28: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 7, 1]
# CHECK-NEXT:  sample 29: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 7, 1, 1]
# CHECK-NEXT:  sample 30: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 4, 1, 1, 1]
# CHECK-NEXT:  sample 31: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 4, 1, 1, 3]
# CHECK-NEXT:  sample 32: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 4, 1, 7, 1]
# CHECK-NEXT:  sample 33: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 4, 7, 1, 1]
# CHECK-NEXT:  sample 34: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 8, 1, 1, 1]
# CHECK-NEXT:  sample 35: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 8, 1, 1, 3]
# CHECK-NEXT:  sample 36: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 8, 1, 7, 1]
# CHECK-NEXT:  sample 37: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 8, 7, 1, 1]
# CHECK-NEXT:  sample 38: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 16, 1, 1, 1]
# CHECK-NEXT:  sample 39: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 16, 1, 1, 3]
# CHECK-NEXT:  sample 40: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 16, 1, 7, 1]
# CHECK-NEXT:  sample 41: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 16, 7, 1, 1]
# CHECK-NEXT:  sample 42: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 1, 1]
# CHECK-NEXT:  sample 43: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 1, 3]
# CHECK-NEXT:  sample 44: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 7, 1]
# CHECK-NEXT:  sample 45: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 7, 1, 1]
# CHECK-NEXT:  sample 46: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 2, 1, 1, 1]
# CHECK-NEXT:  sample 47: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 2, 1, 1, 3]
# CHECK-NEXT:  sample 48: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 2, 1, 7, 1]
# CHECK-NEXT:  sample 49: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 2, 7, 1, 1]
# CHECK-NEXT:  sample 50: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 1, 1, 1]
# CHECK-NEXT:  sample 51: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 1, 1, 3]
# CHECK-NEXT:  sample 52: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 1, 7, 1]
# CHECK-NEXT:  sample 53: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 7, 1, 1]
# CHECK-NEXT:  sample 54: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 8, 1, 1, 1]
# CHECK-NEXT:  sample 55: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 8, 1, 1, 3]
# CHECK-NEXT:  sample 56: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 8, 1, 7, 1]
# CHECK-NEXT:  sample 57: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 8, 7, 1, 1]
# CHECK-NEXT:  sample 58: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1, 1]
# CHECK-NEXT:  sample 59: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1, 3]
# CHECK-NEXT:  sample 60: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 7, 1]
# CHECK-NEXT:  sample 61: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 7, 1, 1]
# CHECK-NEXT:  sample 62: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 2, 1, 1, 1]
# CHECK-NEXT:  sample 63: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 2, 1, 1, 3]
# CHECK-NEXT:  sample 64: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 2, 1, 7, 1]
# CHECK-NEXT:  sample 65: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 2, 7, 1, 1]
# CHECK-NEXT:  sample 66: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 4, 1, 1, 1]
# CHECK-NEXT:  sample 67: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 4, 1, 1, 3]
# CHECK-NEXT:  sample 68: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 4, 1, 7, 1]
# CHECK-NEXT:  sample 69: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 4, 7, 1, 1]
# CHECK-NEXT:  sample 70: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 1, 1]
# CHECK-NEXT:  sample 71: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 1, 3]
# CHECK-NEXT:  sample 72: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 7, 1]
# CHECK-NEXT:  sample 73: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 7, 1, 1]
# CHECK-NEXT:  sample 74: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 2, 1, 1, 1]
# CHECK-NEXT:  sample 75: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 2, 1, 1, 3]
# CHECK-NEXT:  sample 76: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 2, 1, 7, 1]
# CHECK-NEXT:  sample 77: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 2, 7, 1, 1]
# CHECK-NEXT:  sample 78: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 32, 1, 1, 1, 1]
# CHECK-NEXT:  sample 79: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 32, 1, 1, 1, 3]
# CHECK-NEXT:  sample 80: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 32, 1, 1, 7, 1]
# CHECK-NEXT:  sample 81: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 32, 1, 7, 1, 1]
# CHECK-NEXT:  sample 82: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1]
# CHECK-NEXT:  sample 83: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 3]
# CHECK-NEXT:  sample 84: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 7, 1]
# CHECK-NEXT:  sample 85: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 7, 1, 1]
# CHECK-NEXT:  sample 86: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 1, 1, 1]
# CHECK-NEXT:  sample 87: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 1, 1, 3]
# CHECK-NEXT:  sample 88: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 1, 7, 1]
# CHECK-NEXT:  sample 89: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 7, 1, 1]
# CHECK-NEXT:  sample 90: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 4, 1, 1, 1]
# CHECK-NEXT:  sample 91: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 4, 1, 1, 3]
# CHECK-NEXT:  sample 92: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 4, 1, 7, 1]
# CHECK-NEXT:  sample 93: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 4, 7, 1, 1]
# CHECK-NEXT:  sample 94: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 8, 1, 1, 1]
# CHECK-NEXT:  sample 95: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 8, 1, 1, 3]
# CHECK-NEXT:  sample 96: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 8, 1, 7, 1]
# CHECK-NEXT:  sample 97: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 8, 7, 1, 1]
# CHECK-NEXT:  sample 98: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 16, 1, 1, 1]
# CHECK-NEXT:  sample 99: [1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 16, 1, 1, 3]
# CHECK-NEXT:  stats {'filtered': 100, 'all': 202}
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_fill', node_ident='__xtc_id_%2_fill_', dims=['b', 'h', 'w', 'f'], loop_stamps=[], splits={}, tiles={'b': {'b': 1}, 'h': {'h': 1}, 'w': {'w': 1}, 'f': {'f': 1}}, permutation={'.': ['b', 'h', 'w', 'f']}, vectorization=[], parallelization=[], unrolling={}), MlirNodeSchedule(node_name='%2_reduce', node_ident='__xtc_id_%2_reduce_', dims=['b', 'h', 'w', 'f', 'r', 's', 'c'], loop_stamps=[], splits={}, tiles={'b': {'b': 1, 'b1': 1, 'b2': 1, 'b3': 1}, 'h': {'h': 1, 'h1': 1, 'h2': 1, 'h3': 1}, 'w': {'w': 1, 'w1': 1, 'w2': 1, 'w3': 1}, 'f': {'f': 32, 'f1': 16, 'f2': 16, 'f3': 1}, 'r': {'r': 1, 'r1': 1}, 's': {'s': 1, 's1': 1}, 'c': {'c': 3, 'c1': 1}}, permutation={'%2_reduce': ['b', 'h', 'w', 'f', 'b1', 'h1', 'w1', 'f1', 'r', 's', 'c', 'b2', 'h2', 'w2', 'f2', 'r1', 's1', 'c1', 'b3', 'h3', 'w3', 'f3']}, vectorization=['f3'], parallelization=['b'], unrolling={'f3': 16, 'w3': 1, 'h3': 1, 'b3': 1, 'c1': 3, 's1': 1, 'r1': 1})]
